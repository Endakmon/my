<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bilos Car GPS Event</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icons/bilos-512.png">
  <style>
    /* ... your original CSS unchanged ... */
  </style>
</head>
<body>
  <div id="loadingMsg" style="display:none;text-align:center;color:#444;margin-top:12px;"></div>
  <div id="errorMsg" style="display:none;text-align:center;color:red;margin-top:12px;"></div>

  <button class="menu-btn" id="moreMenuBtn" title="More options">
    <span class="menu-dots">
      <span class="menu-dot"></span>
      <span class="menu-dot"></span>
      <span class="menu-dot"></span>
    </span>
  </button>
  <div class="menu-popup" id="menuPopup">
    <button onclick="editSelectedRow()">Edit</button>
    <button onclick="deleteSelectedRow()">Delete</button>
  </div>

  <div class="developer-name-floating"><b>Endakmew</b></div>

  <div class="container" id="pdfArea">
    <div style="text-align:left;margin-bottom:5px;">
      <img src="bilos.png" alt="Logo" style="width:30px;height:auto;" />
    </div>
    <h2>Bilos Driver GPS Information</h2>
    <div class="actions">
      <button onclick="window.location='index.html'">Add More Entries</button>
      <input id="clearInput" type="password" placeholder="Admin code">
      <button id="adminClear" style="display:none" onclick="clearData()">Clear All Data</button>
      <button onclick="exportPDF()">Export as PDF</button>
      <button class="see-more-btn" onclick="seeSelectedOnMap()">See More (Map)</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>Driver Name</th><th>Plate Number</th><th>Starting Point</th><th>Destination</th>
          <th>Date</th><th>Moved Time</th><th>Stopping Time</th><th>Stopping Place</th>
          <th>Moved Unauthorized</th><th>Other GPS Problem</th><th>Technical Problem</th>
        </tr>
      </thead>
      <tbody id="dataRows"></tbody>
    </table>
  </div>

  <div id="mapPopupOverlay" style="display:none;"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script>
    firebase.initializeApp({
      apiKey: "AIzaSyBNXwvhr0Xeczla_65xMBeYo6_1C3szp7c",
      authDomain: "endex-bilos.firebaseapp.com",
      projectId: "endex-bilos",
      storageBucket: "endex-bilos.firebasestorage.app",
      messagingSenderId: "586655593314",
      appId: "1:586655593314:web:60f21bf38c33e0f960f23b"
    });
    const db = firebase.firestore();

    let allEntries = [], lastSelectedRow = null, lastSelectedRowIndex = null, lastSelectedId = null;

    function showLoading(msg="Loading..."){document.getElementById('loadingMsg').textContent=msg;document.getElementById('loadingMsg').style.display='block';}
    function hideLoading(){document.getElementById('loadingMsg').style.display='none';}
    function showError(msg){document.getElementById('errorMsg').innerHTML=msg;document.getElementById('errorMsg').style.display='block';}
    function hideError(){document.getElementById('errorMsg').style.display='none';}

    document.addEventListener('DOMContentLoaded',()=>{
      document.addEventListener('click',e=>{
        const btn = document.getElementById('moreMenuBtn');
        const popup = document.getElementById('menuPopup');
        if(btn.contains(e.target)){
          popup.classList.toggle('active');
          const enabled = lastSelectedRow!==null;
          popup.querySelectorAll('button').forEach(b=>b.disabled=!enabled);
        }else if(!popup.contains(e.target)){
          popup.classList.remove('active');
        }
      });
      document.getElementById('clearInput').addEventListener('input',e=>{
        document.getElementById('adminClear').style.display = e.target.value==="6121" ? 'inline-block' : 'none';
      });
      subscribeToEntries();
    });

    function populateTable(){
      const tbody = document.getElementById('dataRows');
      tbody.innerHTML = allEntries.length === 0 ? 
        '<tr><td colspan="11" style="text-align:center">No data submitted yet.</td></tr>' : '';
      allEntries.forEach((entry, idx)=>{
        const r = document.createElement('tr');
        ['driver','plate','startingPoint','destination','date','movedTime','stoppingTime','stoppingPlace','unauthorised','gpsProblem','techProblem'].forEach(key=>{
          const val = entry[key] && entry[key].trim() ? entry[key] : '-';
          r.insertAdjacentHTML('beforeend', `<td>${val}</td>`);
        });
        r.addEventListener('click',()=>{
          if(lastSelectedRow) lastSelectedRow.classList.remove('selected');
          r.classList.add('selected');
          lastSelectedRow = r; lastSelectedRowIndex = idx; lastSelectedId = entry.id;
          document.getElementById('menuPopup').querySelectorAll('button').forEach(b=>b.disabled=false);
        });
        tbody.appendChild(r);
      });
    }

    function subscribeToEntries(){
      showLoading(); hideError();
      db.collection("gpsEntries").orderBy("createdAt","desc")
        .onSnapshot(snap=>{
          hideLoading(); hideError(); allEntries=[];
          snap.forEach(doc=>allEntries.push({ id: doc.id, ...doc.data() }));
          populateTable();
        }, err=>{
          hideLoading();
          showError("Failed to load data: " + (err.message||err));
        });
    }

    function seeSelectedOnMap(){
      if(lastSelectedRowIndex === null) return alert("Select a row to open map.");
      const e = allEntries[lastSelectedRowIndex];
      showMapPopup(e.stoppingPlace, e.unauthorised);
    }

    function showMapPopup(stop, unAuth){
      const overlay = document.getElementById('mapPopupOverlay');
      overlay.innerHTML = '<div class="popup-overlay"><div class="popup-modal">' +
        '<h3>Open Location in Google Maps</h3>' +
        `<button ${!stop||stop==='-'?'disabled':''} onclick="openOnMap('${encodeURIComponent(stop)}')">Open Stopping Place</button>` +
        (stop&&stop!=='-'?`<div>${stop}</div>`:'') +
        `<button ${!unAuth||unAuth==='-'?'disabled':''} onclick="openOnMap('${encodeURIComponent(unAuth)}')">Open Moved Unauthorised</button>` +
        (unAuth&&unAuth!=='-'?`<div>${unAuth}</div>`:'') +
        `<button class="close-btn" onclick="document.getElementById('mapPopupOverlay').style.display='none'">Close</button>` +
        `</div></div>`;
      overlay.style.display='flex';
      overlay.onclick = e=>{ if(e.target===overlay) overlay.style.display='none'; };
    }

    function openOnMap(enc){
      const p = decodeURIComponent(enc);
      let url = p;
      const coordRe = /^\s*-?\d+(\.\d+)?\s*,\s*-?\d+(\.\d+)?\s*$/;
      if(!p.startsWith('http') && coordRe.test(p)) url=`https://www.google.com/maps/search/?api=1&query=${p}`;
      else if(!p.startsWith('http')) url=`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(p)}`;
      window.open(url,'_blank','width=800,height=600');
    }

    function clearData(){
      if(!confirm("Are you sure you want to clear all data?")) return;
      db.collection("gpsEntries").get().then(snap=>{
        const batch = db.batch();
        snap.forEach(doc=>batch.delete(doc.ref));
        return batch.commit();
      }).then(()=>{
        lastSelectedRow = null; lastSelectedRowIndex = null; lastSelectedId = null;
        alert('All data cleared.');
      }).catch(err=>alert("Error clearing data: "+err));
    }

    function exportPDF(){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation:'landscape' });
      doc.setFontSize(18);
      doc.setFont('helvetica','bold');
      doc.text("Bilos GPS Events", doc.internal.pageSize.getWidth()/2,15,{align:'center'});
      if(allEntries.length === 0){
        doc.setFontSize(12);
        doc.setFont('helvetica','normal');
        doc.text("No data submitted yet.",20,30);
      } else {
        const headers = ['Driver','Plate No','Start','Dest','Date','Moved Time','Stop Time','Stopping Place','Moved Unauthorized','GPS Problem','Tech Problem'];
        const body = allEntries.map(e => [
          e.driver||'-',e.plate||'-',e.startingPoint||'-',e.destination||'-',e.date||'-',
          e.movedTime||'-',e.stoppingTime||'-',e.stoppingPlace||'-',e.unauthorised||'-',e.gpsProblem||'-',e.techProblem||'-'
        ]);
        doc.autoTable({
          startY:25, head:[headers], body:body,
          styles:{fontSize:10,overflow:'linebreak',halign:'center'},
          headStyles:{fillColor:[25,92,202],textColor:255,fontStyle:'bold'}
        });
      }
      const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
      doc.save(`gps-report_${ts}.pdf`);
    }

    function editSelectedRow(){
      if(lastSelectedRowIndex===null) return alert("Select a row to edit.");
      const entry = allEntries[lastSelectedRowIndex];
      const fields = [
        {key:'driver',label:'Driver Name'},{key:'plate',label:'Plate Number'},
        {key:'startingPoint',label:'Starting Point'},{key:'destination',label:'Destination'},
        {key:'date',label:'Date'},{key:'movedTime',label:'Moved Time'},
        {key:'stoppingTime',label:'Stopping Time'},{key:'stoppingPlace',label:'Stopping Place'},
        {key:'unauthorised',label:'Moved Unauthorised Place'},{key:'gpsProblem',label:'Other GPS Problem'},
        {key:'techProblem',label:'Technical Problem'}
      ];
      const updated = {...entry};
      fields.forEach(f=>{
        const val = prompt(`Edit ${f.label}:`, entry[f.key]||"");
        if(val!==null) updated[f.key]=val;
      });
      db.collection("gpsEntries").doc(entry.id).update(updated)
        .then(()=>{
          alert("Entry updated.");
          lastSelectedRow = null; lastSelectedRowIndex = null; lastSelectedId = null;
          document.getElementById('menuPopup').classList.remove('active');
        })
        .catch(err=>alert("Update failed: "+err));
    }

    function deleteSelectedRow(){
      if(lastSelectedRowIndex===null) return alert("Select a row to delete.");
      const code = prompt("Enter admin code to delete this entry:");
      if(code !== "6121") return alert("Wrong code. Cancelled.");
      if(!confirm("Are you sure you want to delete this entry?")) return;
      const entry = allEntries[lastSelectedRowIndex];
      db.collection("gpsEntries").doc(entry.id).delete()
        .then(()=>{
          alert("Entry deleted.");
          lastSelectedRow = null; lastSelectedRowIndex = null; lastSelectedId = null;
          document.getElementById('menuPopup').classList.remove('active');
        })
        .catch(err=>alert("Delete failed: "+err));
    }
  </script>
</body>
</html>
